<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>project-name documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">project-name documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >VaultsService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/vaults/vaults.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>VaultsService</p>
<p>This service manages the creation, publishing, updating, and retrieval of vaults in the system.
It handles business logic for vault lifecycle, including draft and published states, asset and whitelist management,
CSV parsing, transaction confirmation, and integration with AWS S3, blockchain, and related services.</p>
<p>Main responsibilities:</p>
<ul>
<li>Creating and saving new vaults (draft and published)</li>
<li>Managing vault assets, whitelists, tags, and images</li>
<li>Handling vault publishing and transaction confirmation</li>
<li>Providing paginated and filtered vault listings for users</li>
<li>Supporting vault burning (liquidation) operations</li>
<li>Integrating with AWS S3 for CSV parsing and file management</li>
<li>Integrating with blockchain services for on-chain operations</li>
</ul>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#INITIAL_RETRY_DELAY" >INITIAL_RETRY_DELAY</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#logger" >logger</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#MAX_RETRIES" >MAX_RETRIES</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#burnVaultAttempt" >burnVaultAttempt</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#burnVaultPublishTx" >burnVaultPublishTx</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#confirmAndProcessTransaction" >confirmAndProcessTransaction</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createVault" >createVault</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getMyVaults" >getMyVaults</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getVaultById" >getVaultById</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getVaults" >getVaults</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#parseCSVFromS3" >parseCSVFromS3</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#prepareDraftResponse" >prepareDraftResponse</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#publishVault" >publishVault</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveDraftVault" >saveDraftVault</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#wait" >wait</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(vaultsRepository: <a href="../entitys/Vault.html" target="_self">Repository&lt;Vault&gt;</a>, usersRepository: <a href="../entitys/User.html" target="_self">Repository&lt;User&gt;</a>, linksRepository: <a href="../entitys/LinkEntity.html" target="_self">Repository&lt;LinkEntity&gt;</a>, filesRepository: <a href="../entitys/FileEntity.html" target="_self">Repository&lt;FileEntity&gt;</a>, assetsWhitelistRepository: <a href="../interfaces/Asset.html" target="_self">Repository&lt;AssetsWhitelistEntity&gt;</a>, acquirerWhitelistRepository: <a href="../classes/AcquirerWhitelist.html" target="_self">Repository&lt;AcquirerWhitelistEntity&gt;</a>, tagsRepository: <a href="../entitys/TagEntity.html" target="_self">Repository&lt;TagEntity&gt;</a>, contributorWhitelistRepository: <a href="../classes/ContributorWhitelist.html" target="_self">Repository&lt;ContributorWhitelistEntity&gt;</a>, assetsRepository: <a href="../interfaces/Asset.html" target="_self">Repository&lt;Asset&gt;</a>, awsService: <a href="../injectables/AwsService.html" target="_self">AwsService</a>, vaultContractService: <a href="../injectables/VaultManagingService.html" target="_self">VaultManagingService</a>, blockchainScannerService: <a href="../injectables/BlockchainScannerService.html" target="_self">BlockchainScannerService</a>, taptoolsService: <a href="../injectables/TaptoolsService.html" target="_self">TaptoolsService</a>, transactionsService: <a href="../injectables/TransactionsService.html" target="_self">TransactionsService</a>, configService: ConfigService)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="64" class="link-to-prism">src/modules/vaults/vaults.service.ts:64</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>vaultsRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/Vault.html" target="_self" >Repository&lt;Vault&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>usersRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/User.html" target="_self" >Repository&lt;User&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>linksRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/LinkEntity.html" target="_self" >Repository&lt;LinkEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>filesRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/FileEntity.html" target="_self" >Repository&lt;FileEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>assetsWhitelistRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/Asset.html" target="_self" >Repository&lt;AssetsWhitelistEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>acquirerWhitelistRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/AcquirerWhitelist.html" target="_self" >Repository&lt;AcquirerWhitelistEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>tagsRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/TagEntity.html" target="_self" >Repository&lt;TagEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>contributorWhitelistRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/ContributorWhitelist.html" target="_self" >Repository&lt;ContributorWhitelistEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>assetsRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/Asset.html" target="_self" >Repository&lt;Asset&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>awsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AwsService.html" target="_self" >AwsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>vaultContractService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/VaultManagingService.html" target="_self" >VaultManagingService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>blockchainScannerService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/BlockchainScannerService.html" target="_self" >BlockchainScannerService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>taptoolsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/TaptoolsService.html" target="_self" >TaptoolsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>transactionsService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/TransactionsService.html" target="_self" >TransactionsService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>configService</td>
                                                  
                                                        <td>
                                                                    <code>ConfigService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="burnVaultAttempt"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>burnVaultAttempt</b></span>
                        <a href="#burnVaultAttempt"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>burnVaultAttempt(vaultId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="967"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:967</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Attempts to burn (liquidate) a vault, creating a burn transaction if the vault is empty and owned by the user.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>vaultId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Vault ID</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>User ID</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                <p>Burn transaction result</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="burnVaultPublishTx"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>burnVaultPublishTx</b></span>
                        <a href="#burnVaultPublishTx"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>burnVaultPublishTx(vaultId, userId, publishDto: <a href="../classes/PublishVaultDto.html" target="_self">PublishVaultDto</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1005"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:1005</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Publishes a burn transaction for a vault, marking it as deleted and saving the liquidation hash.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>vaultId</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Vault ID</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>User ID</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>publishDto</td>
                                            <td>
                                                            <code><a href="../classes/PublishVaultDto.html" target="_self" >PublishVaultDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>PublishVaultDto containing transaction data</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="confirmAndProcessTransaction"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>confirmAndProcessTransaction</b></span>
                        <a href="#confirmAndProcessTransaction"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>confirmAndProcessTransaction(txHash: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, vault: <a href="../entitys/Vault.html" target="_self">Vault</a>, attempt: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="108"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:108</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Confirms and processes a blockchain transaction for a vault, with retry logic and exponential backoff.
Updates the vault&#39;s contract address upon success.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>txHash</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                                    <ul>
<li>Transaction hash</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>vault</td>
                                            <td>
                                                            <code><a href="../entitys/Vault.html" target="_self" >Vault</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                                    <ul>
<li>Vault entity</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>attempt</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>0</code>
                                            </td>

                                            <td>
                                                    <ul>
<li>Current retry attempt</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createVault"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>createVault</b></span>
                        <a href="#createVault"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createVault(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, data: <a href="../classes/CreateVaultReq.html" target="_self">CreateVaultReq</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="194"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:194</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Creates a new vault with the provided user and data, including validation, file processing, whitelist, and tag management.
Also creates on-chain vault transaction and returns presigned transaction and vault ID.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>ID of the vault owner</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="../classes/CreateVaultReq.html" target="_self" >CreateVaultReq</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Vault creation request data</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>Object with vaultId and presignedTx</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMyVaults"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getMyVaults</b></span>
                        <a href="#getMyVaults"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getMyVaults(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, filter?: <a href="../undefineds/VaultFilter.html" target="_self">VaultFilter</a>, page: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, limit: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, sortBy?: <a href="../undefineds/VaultSortField.html" target="_self">VaultSortField</a>, sortOrder: <a href="../undefineds/SortOrder.html" target="_self">SortOrder</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="677"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:677</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>filter</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#VaultFilter" target="_self" >VaultFilter</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>page</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>1</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>limit</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>10</code>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>sortBy</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#VaultSortField" target="_self" >VaultSortField</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>sortOrder</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#SortOrder" target="_self" >SortOrder</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>SortOrder.DESC</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../entitys/Vault.html" target="_self" >Promise&lt;PaginatedResponseDto&lt;VaultShortResponse&gt;&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getVaultById"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getVaultById</b></span>
                        <a href="#getVaultById"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getVaultById(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, _userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="758"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:758</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Retrieves a vault by ID for a user, including asset and price calculations.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Vault ID</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>_userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>User ID (for access control)</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../classes/VaultFullResponse.html" target="_self" >Promise&lt;VaultFullResponse&gt;</a></code>

                        </div>
                            <div class="io-description">
                                <p>Full vault response</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getVaults"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getVaults</b></span>
                        <a href="#getVaults"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getVaults(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, filter?: <a href="../undefineds/VaultFilter.html" target="_self">VaultFilter</a>, page: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, limit: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, sortBy?: <a href="../undefineds/VaultSortField.html" target="_self">VaultSortField</a>, sortOrder: <a href="../undefineds/SortOrder.html" target="_self">SortOrder</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="828"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:828</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Retrieves paginated and filtered list of vaults accessible to the user, with access control and sorting.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                                    <ul>
<li>ID of the user</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>filter</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#VaultFilter" target="_self" >VaultFilter</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                                    <ul>
<li>Optional vault filter</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>page</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>1</code>
                                            </td>

                                            <td>
                                                    <ul>
<li>Page number</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>limit</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>10</code>
                                            </td>

                                            <td>
                                                    <ul>
<li>Items per page</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>sortBy</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#VaultSortField" target="_self" >VaultSortField</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                                    <ul>
<li>Field to sort by</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>sortOrder</td>
                                            <td>
                                                            <code><a href="../miscellaneous/enumerations.html#SortOrder" target="_self" >SortOrder</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>SortOrder.DESC</code>
                                            </td>

                                            <td>
                                                    <ul>
<li>Sort order</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../entitys/Vault.html" target="_self" >Promise&lt;PaginatedResponseDto&lt;VaultShortResponse&gt;&gt;</a></code>

                        </div>
                            <div class="io-description">
                                <p>Paginated response of vaults</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="parseCSVFromS3"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>parseCSVFromS3</b></span>
                        <a href="#parseCSVFromS3"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>parseCSVFromS3(file_key: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="158"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:158</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Parses a CSV file from AWS S3 and extracts valid Cardano addresses.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>file_key</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>S3 file key</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string[]&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>Array of valid Cardano addresses</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="prepareDraftResponse"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>prepareDraftResponse</b></span>
                        <a href="#prepareDraftResponse"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>prepareDraftResponse(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="740"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:740</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>id</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="publishVault"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>publishVault</b></span>
                        <a href="#publishVault"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>publishVault(userId, signedTx)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="459"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:459</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Publishes a vault by submitting a signed transaction and updating vault status.
Starts transaction confirmation in the background.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>ID of the vault owner</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>signedTx</td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Signed transaction object</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                <p>Full vault response</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveDraftVault"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>saveDraftVault</b></span>
                        <a href="#saveDraftVault"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveDraftVault(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, data: <a href="../classes/SaveDraftReq.html" target="_self">SaveDraftReq</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="488"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:488</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Saves a draft vault or updates an existing draft, including file, whitelist, and tag management.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>ID of the vault owner</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                            <code><a href="../classes/SaveDraftReq.html" target="_self" >SaveDraftReq</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Draft vault request data</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>Draft vault response</p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="wait"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>wait</b></span>
                        <a href="#wait"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>wait(ms: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="97"
                                    class="link-to-prism">src/modules/vaults/vaults.service.ts:97</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Waits asynchronously for a specified number of milliseconds.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ms</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Milliseconds to wait</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="INITIAL_RETRY_DELAY"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>INITIAL_RETRY_DELAY</b></span>
                        <a href="#INITIAL_RETRY_DELAY"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>3000</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="64" class="link-to-prism">src/modules/vaults/vaults.service.ts:64</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="logger"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>logger</b></span>
                        <a href="#logger"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Logger(VaultsService.name)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="62" class="link-to-prism">src/modules/vaults/vaults.service.ts:62</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="MAX_RETRIES"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>MAX_RETRIES</b></span>
                        <a href="#MAX_RETRIES"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>10</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="63" class="link-to-prism">src/modules/vaults/vaults.service.ts:63</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Credential, EnterpriseAddress, ScriptHash } from &#x27;@emurgo/cardano-serialization-lib-nodejs&#x27;;
import { BadRequestException, Injectable, Logger, UnauthorizedException } from &#x27;@nestjs/common&#x27;;
import { ConfigService } from &#x27;@nestjs/config&#x27;;
import { InjectRepository } from &#x27;@nestjs/typeorm&#x27;;
import { classToPlain, plainToInstance } from &#x27;class-transformer&#x27;;
import * as csv from &#x27;csv-parse&#x27;;
import { Brackets, In, Repository } from &#x27;typeorm&#x27;;

import { AwsService } from &#x27;../aws_bucket/aws.service&#x27;;
import { TaptoolsService } from &#x27;../taptools/taptools.service&#x27;;

import { CreateVaultReq } from &#x27;./dto/createVault.req&#x27;;
import { SortOrder, VaultFilter, VaultSortField } from &#x27;./dto/get-vaults.dto&#x27;;
import { PaginatedResponseDto } from &#x27;./dto/paginated-response.dto&#x27;;
import { PublishVaultDto } from &#x27;./dto/publish-vault.dto&#x27;;
import { SaveDraftReq } from &#x27;./dto/saveDraft.req&#x27;;
import { VaultFullResponse, VaultShortResponse } from &#x27;./dto/vault.response&#x27;;
import { TransactionsService } from &#x27;./processing-tx/offchain-tx/transactions.service&#x27;;
import { BlockchainScannerService } from &#x27;./processing-tx/onchain/blockchain-scanner.service&#x27;;
import { valuation_sc_type, vault_sc_privacy } from &#x27;./processing-tx/onchain/types/vault-sc-type&#x27;;
import { applyContributeParams } from &#x27;./processing-tx/onchain/utils/apply_params&#x27;;
import { VaultManagingService } from &#x27;./processing-tx/onchain/vault-managing.service&#x27;;

import { AcquirerWhitelistEntity } from &#x27;@/database/acquirerWhitelist.entity&#x27;;
import { Asset } from &#x27;@/database/asset.entity&#x27;;
import { AssetsWhitelistEntity } from &#x27;@/database/assetsWhitelist.entity&#x27;;
import { ContributorWhitelistEntity } from &#x27;@/database/contributorWhitelist.entity&#x27;;
import { FileEntity } from &#x27;@/database/file.entity&#x27;;
import { LinkEntity } from &#x27;@/database/link.entity&#x27;;
import { TagEntity } from &#x27;@/database/tag.entity&#x27;;
import { User } from &#x27;@/database/user.entity&#x27;;
import { Vault } from &#x27;@/database/vault.entity&#x27;;
import { transformToSnakeCase } from &#x27;@/helpers&#x27;;
import { AssetOriginType, AssetStatus, AssetType } from &#x27;@/types/asset.types&#x27;;
import { TransactionType } from &#x27;@/types/transaction.types&#x27;;
import {
  ContributionWindowType,
  InvestmentWindowType,
  ValueMethod,
  VaultPrivacy,
  VaultStatus,
} from &#x27;@/types/vault.types&#x27;;

/**
 * VaultsService
 *
 * This service manages the creation, publishing, updating, and retrieval of vaults in the system.
 * It handles business logic for vault lifecycle, including draft and published states, asset and whitelist management,
 * CSV parsing, transaction confirmation, and integration with AWS S3, blockchain, and related services.
 *
 * Main responsibilities:
 * - Creating and saving new vaults (draft and published)
 * - Managing vault assets, whitelists, tags, and images
 * - Handling vault publishing and transaction confirmation
 * - Providing paginated and filtered vault listings for users
 * - Supporting vault burning (liquidation) operations
 * - Integrating with AWS S3 for CSV parsing and file management
 * - Integrating with blockchain services for on-chain operations
 */
@Injectable()
export class VaultsService {
  private readonly logger &#x3D; new Logger(VaultsService.name);
  private readonly MAX_RETRIES &#x3D; 10;
  private readonly INITIAL_RETRY_DELAY &#x3D; 3000; // 3 seconds

  constructor(
    @InjectRepository(Vault)
    private readonly vaultsRepository: Repository&lt;Vault&gt;,
    @InjectRepository(User)
    private readonly usersRepository: Repository&lt;User&gt;,
    @InjectRepository(LinkEntity)
    private readonly linksRepository: Repository&lt;LinkEntity&gt;,
    @InjectRepository(FileEntity)
    private readonly filesRepository: Repository&lt;FileEntity&gt;,
    @InjectRepository(AssetsWhitelistEntity)
    private readonly assetsWhitelistRepository: Repository&lt;AssetsWhitelistEntity&gt;,
    @InjectRepository(AcquirerWhitelistEntity)
    private readonly acquirerWhitelistRepository: Repository&lt;AcquirerWhitelistEntity&gt;,
    @InjectRepository(TagEntity)
    private readonly tagsRepository: Repository&lt;TagEntity&gt;,
    @InjectRepository(ContributorWhitelistEntity)
    private readonly contributorWhitelistRepository: Repository&lt;ContributorWhitelistEntity&gt;,
    @InjectRepository(Asset)
    private readonly assetsRepository: Repository&lt;Asset&gt;,
    private readonly awsService: AwsService,
    private readonly vaultContractService: VaultManagingService,
    private readonly blockchainScannerService: BlockchainScannerService,
    private readonly taptoolsService: TaptoolsService,
    private readonly transactionsService: TransactionsService,
    private readonly configService: ConfigService
  ) {}

  /**
   * Waits asynchronously for a specified number of milliseconds.
   * @param ms - Milliseconds to wait
   */
  private async wait(ms: number): Promise&lt;void&gt; {
    return new Promise(resolve &#x3D;&gt; setTimeout(resolve, ms));
  }

  /**
   * Confirms and processes a blockchain transaction for a vault, with retry logic and exponential backoff.
   * Updates the vault&#x27;s contract address upon success.
   * @param txHash - Transaction hash
   * @param vault - Vault entity
   * @param attempt - Current retry attempt
   */
  private async confirmAndProcessTransaction(txHash: string, vault: Vault, attempt &#x3D; 0): Promise&lt;void&gt; {
    try {
      this.logger.log(&#x60;Checking transaction status (attempt ${attempt + 1}): ${txHash}&#x60;);

      const txDetail &#x3D; await this.blockchainScannerService.getTransactionDetails(txHash);

      if (!txDetail || !txDetail.output_amount || txDetail.output_amount.length &lt; 2) {
        throw new Error(&#x27;Transaction output not found or invalid format&#x27;);
      }

      const { output_amount } &#x3D; txDetail;
      const vaultPolicyPlusName &#x3D; output_amount[output_amount.length - 1].unit;
      const VAULT_POLICY_ID &#x3D; vaultPolicyPlusName.slice(0, 56);
      const VAULT_ID &#x3D; vaultPolicyPlusName.slice(56);

      const parameterizedScript &#x3D; applyContributeParams({
        vault_policy_id: VAULT_POLICY_ID,
        vault_id: VAULT_ID,
      });

      const POLICY_ID &#x3D; parameterizedScript.validator.hash;
      const SC_ADDRESS &#x3D; EnterpriseAddress.new(0, Credential.from_scripthash(ScriptHash.from_hex(POLICY_ID)))
        .to_address()
        .to_bech32();

      vault.contract_address &#x3D; SC_ADDRESS;
      await this.vaultsRepository.save(vault);

      this.logger.log(&#x60;Successfully processed transaction ${txHash} for vault ${vault.id}&#x60;);
    } catch (error) {
      this.logger.log(&#x27;Publication tx failed &#x27;);
      if (attempt &gt;&#x3D; this.MAX_RETRIES - 1) {
        this.logger.error(&#x60;Max retries reached for transaction ${txHash}:&#x60;, error);
        return;
      }

      // Exponential backoff: 3s, 6s, 12s, 24s, etc.
      const delay &#x3D; this.INITIAL_RETRY_DELAY * Math.pow(2, attempt);
      this.logger.log(&#x60;Retrying in ${delay}ms...&#x60;);

      await this.wait(delay);
      return this.confirmAndProcessTransaction(txHash, vault, attempt + 1);
    }
  }

  /**
   * Parses a CSV file from AWS S3 and extracts valid Cardano addresses.
   * @param file_key - S3 file key
   * @returns Array of valid Cardano addresses
   */
  private async parseCSVFromS3(file_key: string): Promise&lt;string[]&gt; {
    try {
      const csvStream &#x3D; await this.awsService.getCsv(file_key);
      const csvData &#x3D; await csvStream.data.toArray();
      const csvString &#x3D; Buffer.concat(csvData).toString();

      return new Promise((resolve, reject) &#x3D;&gt; {
        const results: string[] &#x3D; [];
        csv
          .parse(csvString, {
            columns: false,
            skip_empty_lines: true,
            trim: true,
          })
          .on(&#x27;data&#x27;, data &#x3D;&gt; {
            const address &#x3D; data[0];
            if (address &amp;&amp; typeof address &#x3D;&#x3D;&#x3D; &#x27;string&#x27; &amp;&amp; /^addr1[a-zA-Z0-9]{98}$/.test(address)) {
              results.push(address);
            }
          })
          .on(&#x27;end&#x27;, () &#x3D;&gt; resolve(results))
          .on(&#x27;error&#x27;, error &#x3D;&gt; reject(error));
      });
    } catch (error) {
      console.error(&#x27;Error parsing CSV from S3:&#x27;, error);
      throw new BadRequestException(&#x27;Failed to parse CSV file from S3&#x27;);
    }
  }

  /**
   * Creates a new vault with the provided user and data, including validation, file processing, whitelist, and tag management.
   * Also creates on-chain vault transaction and returns presigned transaction and vault ID.
   * @param userId - ID of the vault owner
   * @param data - Vault creation request data
   * @returns Object with vaultId and presignedTx
   */
  async createVault(userId: string, data: CreateVaultReq): Promise&lt;any&gt; {
    try {
      const owner &#x3D; await this.usersRepository.findOne({
        where: { id: userId },
      });

      if (!owner) {
        throw new UnauthorizedException(&#x27;User was not authorized!&#x27;);
      }

      // Validate valuation type based on privacy setting
      if (data.privacy &#x3D;&#x3D;&#x3D; VaultPrivacy.public &amp;&amp; data.valueMethod !&#x3D;&#x3D; ValueMethod.lbe) {
        throw new BadRequestException(&#x27;Public vaults can only use LBE valuation type&#x27;);
      }
      if (
        (data.privacy &#x3D;&#x3D;&#x3D; VaultPrivacy.private || data.privacy &#x3D;&#x3D;&#x3D; VaultPrivacy.semiPrivate) &amp;&amp;
        ![ValueMethod.lbe, ValueMethod.fixed].includes(data.valueMethod)
      ) {
        throw new BadRequestException(&#x27;Private and semi-private vaults can use either LBE or fixed valuation type&#x27;);
      }

      // Validate required fields for fixed valuation type
      if (data.valueMethod &#x3D;&#x3D;&#x3D; ValueMethod.fixed) {
        if (!data.valuationCurrency) {
          throw new BadRequestException(&#x27;Valuation currency is required when using fixed valuation type&#x27;);
        }
        if (!data.valuationAmount) {
          throw new BadRequestException(&#x27;Valuation amount is required when using fixed valuation type&#x27;);
        }
      }

      // Process image files
      const imgKey &#x3D; data.vaultImage?.split(&#x27;image/&#x27;)[1];
      const vaultImg &#x3D; imgKey
        ? await this.filesRepository.findOne({
            where: { file_key: imgKey },
          })
        : null;

      const ftTokenImgKey &#x3D; data.ftTokenImg?.split(&#x27;image/&#x27;)[1];
      const ftTokenImg &#x3D; ftTokenImgKey
        ? await this.filesRepository.findOne({
            where: { file_key: ftTokenImgKey },
          })
        : null;

      const acquirerWhitelistCsvKey &#x3D; data.acquirerWhitelistCsv?.key;
      const acquirerWhitelistFile &#x3D; acquirerWhitelistCsvKey
        ? await this.filesRepository.findOne({
            where: { file_key: acquirerWhitelistCsvKey },
          })
        : null;

      const contributorWhitelistCsvKey &#x3D; data.contributorWhitelistCsv?.split(&#x27;csv/&#x27;)[1];
      const contributorWhitelistFile &#x3D; contributorWhitelistCsvKey
        ? await this.filesRepository.findOne({
            where: { file_key: contributorWhitelistCsvKey },
          })
        : null;

      // Prepare vault data
      const vaultData &#x3D; transformToSnakeCase({
        ...data,
        owner: owner,
        contributionDuration: data.contributionDuration,
        acquireWindowDuration: data.acquireWindowDuration,
        acquireOpenWindowTime: new Date(data.acquireOpenWindowTime).toISOString(),
        contributionOpenWindowTime: new Date(data.contributionOpenWindowTime).toISOString(),
        timeElapsedIsEqualToTime: data.timeElapsedIsEqualToTime,
        vaultStatus: VaultStatus.created,
        vaultImage: vaultImg,
        ftTokenImg: ftTokenImg,
        acquirerWhitelistCsv: acquirerWhitelistFile,
        contributorWhitelistCsv: contributorWhitelistFile,
      });

      delete vaultData.assets_whitelist;
      delete vaultData.acquirer_whitelist;
      delete vaultData.contributor_whitelist;
      delete vaultData.tags;

      const newVault &#x3D; await this.vaultsRepository.save(vaultData as Vault);

      // Handle social links
      if (data.socialLinks?.length &gt; 0) {
        const links &#x3D; data.socialLinks.map(linkItem &#x3D;&gt; {
          return this.linksRepository.create({
            vault: newVault,
            name: linkItem.name,
            url: linkItem.url,
          });
        });
        await this.linksRepository.save(links);
      }

      // Handle assets whitelist
      let maxCountOf &#x3D; 0;
      if (data.assetsWhitelist?.length &gt; 0) {
        await Promise.all(
          data.assetsWhitelist.map(assetItem &#x3D;&gt; {
            if (assetItem.policyId) {
              // Sum up the countCapMax values
              if (assetItem.countCapMax) {
                maxCountOf +&#x3D; assetItem.countCapMax;
              }
              return this.assetsWhitelistRepository.save({
                vault: newVault,
                policy_id: assetItem.policyId,
                asset_count_cap_min: assetItem.countCapMin,
                asset_count_cap_max: assetItem.countCapMax,
              });
            }
          })
        );
      }

      newVault.max_contribute_assets &#x3D; Number(maxCountOf) || 0;
      await this.vaultsRepository.save(newVault);
      // Handle acquirer whitelist
      const acquirerFromCsv &#x3D; acquirerWhitelistFile ? await this.parseCSVFromS3(acquirerWhitelistFile.file_key) : [];

      const acquirer &#x3D; data.acquirerWhitelist ? [...data.acquirerWhitelist.map(item &#x3D;&gt; item.walletAddress)] : [];

      const allAcquirer &#x3D; new Set([...acquirer, ...acquirerFromCsv]);

      await Promise.all(
        Array.from(allAcquirer).map(walletAddress &#x3D;&gt; {
          return this.acquirerWhitelistRepository.save({
            vault: newVault,
            wallet_address: walletAddress,
          });
        })
      );

      // Handle contributors whitelist
      const contributorsFromCsv &#x3D; contributorWhitelistFile
        ? await this.parseCSVFromS3(contributorWhitelistFile.file_key)
        : [];

      const contributorList &#x3D; data.contributorWhitelist
        ? [...(data.contributorWhitelist.map(item &#x3D;&gt; item.policyId) || [])]
        : [];

      const allContributors &#x3D; new Set([...contributorList, ...contributorsFromCsv]);
      const contributorsArray &#x3D; [...allContributors];

      contributorsArray.map(item &#x3D;&gt; {
        return this.contributorWhitelistRepository.save({
          vault: newVault,
          wallet_address: item,
        });
      });

      // Handle tags
      if (data.tags?.length &gt; 0) {
        const tags &#x3D; await Promise.all(
          data.tags.map(async tagData &#x3D;&gt; {
            let tag &#x3D; await this.tagsRepository.findOne({
              where: { name: tagData.name },
            });
            if (!tag) {
              tag &#x3D; await this.tagsRepository.save({
                name: tagData.name,
              });
            }
            return tag;
          })
        );
        newVault.tags &#x3D; tags;
        await this.vaultsRepository.save(newVault);
      }

      const finalVault &#x3D; await this.vaultsRepository.findOne({
        where: { id: newVault.id },
        relations: [
          &#x27;owner&#x27;,
          &#x27;social_links&#x27;,
          &#x27;assets_whitelist&#x27;,
          &#x27;acquirer_whitelist&#x27;,
          &#x27;contributor_whitelist&#x27;,
          &#x27;tags&#x27;,
          &#x27;vault_image&#x27;,
          &#x27;banner_image&#x27;,
          &#x27;ft_token_img&#x27;,
        ],
      });

      if (!finalVault) {
        throw new BadRequestException(&#x27;Failed to retrieve created vault&#x27;);
      }

      const policyWhitelist &#x3D; finalVault?.assets_whitelist.map(item &#x3D;&gt; item.policy_id);

      const privacy &#x3D; vault_sc_privacy[finalVault.privacy as VaultPrivacy];
      const valueMethod &#x3D; valuation_sc_type[finalVault.value_method as ValueMethod];

      // Calculate start time based on contribution window type
      let startTime: number;
      if (finalVault.contribution_open_window_type &#x3D;&#x3D;&#x3D; ContributionWindowType.uponVaultLaunch) {
        startTime &#x3D; new Date().getTime();
      } else if (
        finalVault.contribution_open_window_type &#x3D;&#x3D;&#x3D; ContributionWindowType.custom &amp;&amp;
        finalVault.contribution_open_window_time
      ) {
        // contribution_open_window_time is already in milliseconds due to @Transform in entity
        startTime &#x3D; Number(finalVault.contribution_open_window_time);
      } else {
        throw new BadRequestException(&#x27;Invalid contribution window configuration&#x27;);
      }

      const assetWindow &#x3D; {
        start: startTime,
        end: startTime + Number(finalVault.contribution_duration),
      };

      // Calculate acquire window start time
      let acquireStartTime: number;
      if (finalVault.acquire_open_window_type &#x3D;&#x3D;&#x3D; InvestmentWindowType.uponAssetWindowClosing) {
        acquireStartTime &#x3D; assetWindow.end;
      } else if (
        finalVault.acquire_open_window_type &#x3D;&#x3D;&#x3D; InvestmentWindowType.custom &amp;&amp;
        finalVault.acquire_open_window_time
      ) {
        // acquire_open_window_time is already in milliseconds due to @Transform in entity
        acquireStartTime &#x3D; Number(finalVault.acquire_open_window_time);
      } else {
        throw new BadRequestException(&#x27;Invalid acquire window configuration&#x27;);
      }

      const acquireWindow &#x3D; {
        start: acquireStartTime,
        end: acquireStartTime + Number(finalVault.acquire_window_duration),
      };

      const { presignedTx, contractAddress, vaultAssetName } &#x3D; await this.vaultContractService.createOnChainVaultTx({
        vaultName: finalVault.name,
        customerAddress: finalVault.owner.address,
        vaultId: finalVault.id,
        allowedPolicies: policyWhitelist,
        contractType: privacy,
        valueMethod: valueMethod,
        assetWindow,
        acquireWindow,
      });

      finalVault.contract_address &#x3D; contractAddress;
      finalVault.asset_vault_name &#x3D; vaultAssetName;
      await this.vaultsRepository.save(finalVault);
      return {
        vaultId: finalVault.id,
        presignedTx,
      };
    } catch (error) {
      console.error(error);
      throw new BadRequestException(&#x27;Failed to create vault&#x27;);
    }
  }

  /**
   * Publishes a vault by submitting a signed transaction and updating vault status.
   * Starts transaction confirmation in the background.
   * @param userId - ID of the vault owner
   * @param signedTx - Signed transaction object
   * @returns Full vault response
   */
  async publishVault(userId, signedTx) {
    const vault &#x3D; await this.vaultsRepository.findOne({
      where: {
        id: signedTx.vaultId,
      },
      relations: [&#x27;owner&#x27;],
    });
    if (vault.owner.id !&#x3D;&#x3D; userId) {
      throw new UnauthorizedException(&#x27;You must be an owner of vault!&#x27;);
    }

    const publishedTx &#x3D; await this.vaultContractService.submitOnChainVaultTx(signedTx);
    vault.vault_status &#x3D; VaultStatus.published;
    vault.publication_hash &#x3D; publishedTx.txHash;
    await this.vaultsRepository.save(vault);
    // Start transaction confirmation process in background
    this.confirmAndProcessTransaction(publishedTx.txHash, vault).catch(error &#x3D;&gt; {
      this.logger.error(&#x60;Failed to process transaction ${publishedTx.txHash}:&#x60;, error);
    });

    return plainToInstance(VaultFullResponse, classToPlain(vault), { excludeExtraneousValues: true });
  }

  /**
   * Saves a draft vault or updates an existing draft, including file, whitelist, and tag management.
   * @param userId - ID of the vault owner
   * @param data - Draft vault request data
   * @returns Draft vault response
   */
  async saveDraftVault(userId: string, data: SaveDraftReq): Promise&lt;any&gt; {
    let existingVault: Vault | null &#x3D; null;

    // Check for existing draft vault if ID is provided
    if (data.id) {
      existingVault &#x3D; await this.vaultsRepository.findOne({
        where: {
          id: data.id,
          vault_status: VaultStatus.draft,
          owner: { id: userId },
        },
        relations: [&#x27;owner&#x27;, &#x27;social_links&#x27;, &#x27;assets_whitelist&#x27;, &#x27;acquirer_whitelist&#x27;],
      });

      // If found but not a draft, throw error
      if (existingVault &amp;&amp; existingVault.vault_status !&#x3D;&#x3D; VaultStatus.draft) {
        throw new BadRequestException(&#x27;Cannot modify a published vault&#x27;);
      }

      // If found and is draft, remove existing relationships
      if (existingVault) {
        if (existingVault.social_links?.length &gt; 0) {
          await this.linksRepository.remove(existingVault.social_links);
        }
        if (existingVault.assets_whitelist?.length &gt; 0) {
          await this.assetsWhitelistRepository.remove(existingVault.assets_whitelist);
        }
        if (existingVault.acquirer_whitelist?.length &gt; 0) {
          await this.acquirerWhitelistRepository.remove(existingVault.acquirer_whitelist);
        }
      }
    }
    try {
      const owner &#x3D; await this.usersRepository.findOne({
        where: { id: userId },
      });

      // Process image files
      const imgKey &#x3D; data.vaultImage?.split(&#x27;image/&#x27;)[1];
      const vaultImg &#x3D; imgKey
        ? await this.filesRepository.findOne({
            where: { file_key: imgKey },
          })
        : null;

      const bannerImgKey &#x3D; data.bannerImage?.split(&#x27;image/&#x27;)[1];
      const bannerImg &#x3D; bannerImgKey
        ? await this.filesRepository.findOne({
            where: { file_key: bannerImgKey },
          })
        : null;

      const ftTokenImgKey &#x3D; data.ftTokenImg?.split(&#x27;image/&#x27;)[1];
      const ftTokenImg &#x3D; ftTokenImgKey
        ? await this.filesRepository.findOne({
            where: { file_key: ftTokenImgKey },
          })
        : null;

      const acquirerWhitelistCsvKey &#x3D; data.acquirerWhitelistCsv?.key;
      const acquirerWhitelistFile &#x3D; acquirerWhitelistCsvKey
        ? await this.filesRepository.findOne({
            where: { file_key: acquirerWhitelistCsvKey },
          })
        : null;

      // Prepare vault data with only the provided fields
      const vaultData: any &#x3D; {
        owner: owner,
        vault_status: VaultStatus.draft,
      };

      // Only include fields that are actually provided
      if (data.name !&#x3D;&#x3D; undefined) vaultData.name &#x3D; data.name;
      if (data.type !&#x3D;&#x3D; undefined) vaultData.type &#x3D; data.type;
      if (data.privacy !&#x3D;&#x3D; undefined) vaultData.privacy &#x3D; data.privacy;
      if (data.valueMethod !&#x3D;&#x3D; undefined) vaultData.value_method &#x3D; data.valueMethod;
      if (data.valuationCurrency !&#x3D;&#x3D; undefined) vaultData.valuation_currency &#x3D; data.valuationCurrency;
      if (data.valuationAmount !&#x3D;&#x3D; undefined) vaultData.valuation_amount &#x3D; data.valuationAmount;
      if (data.description !&#x3D;&#x3D; undefined) vaultData.description &#x3D; data.description;
      if (data.ftTokenDecimals) vaultData.ftToken_decimals &#x3D; data.ftTokenDecimals;
      if (data.acquireOpenWindowType) vaultData.acquire_open_window_type &#x3D; data.acquireOpenWindowType;

      // Handle date fields only if they are provided
      if (data.contributionDuration !&#x3D;&#x3D; undefined) {
        vaultData.contribution_duration &#x3D; data.contributionDuration;
      }
      if (data.acquireWindowDuration !&#x3D;&#x3D; undefined) {
        vaultData.acquire_window_duration &#x3D; data.acquireWindowDuration;
      }
      if (data.acquireOpenWindowTime !&#x3D;&#x3D; undefined) {
        vaultData.acquire_open_window_time &#x3D; new Date(data.acquireOpenWindowTime).toISOString();
      }
      if (data.contributionOpenWindowTime !&#x3D;&#x3D; undefined) {
        vaultData.contribution_open_window_time &#x3D; new Date(data.contributionOpenWindowTime).toISOString();
      }
      if (data.timeElapsedIsEqualToTime !&#x3D;&#x3D; undefined) {
        vaultData.time_elapsed_is_equal_to_time &#x3D; data.timeElapsedIsEqualToTime;
      }

      // Handle file relationships only if provided
      if (vaultImg) vaultData.vault_image &#x3D; vaultImg;
      if (bannerImg) vaultData.banner_image &#x3D; bannerImg;
      if (ftTokenImg) vaultData.ft_token_img &#x3D; ftTokenImg;
      if (acquirerWhitelistFile) vaultData.acquirer_whitelist_csv &#x3D; acquirerWhitelistFile;

      let vault: Vault;
      if (existingVault) {
        // Update only the provided fields in existing draft vault
        vault &#x3D; (await this.vaultsRepository.save({
          ...existingVault,
          ...vaultData,
        })) as Vault;
      } else {
        // Create new draft vault with provided fields
        vault &#x3D; await this.vaultsRepository.save(vaultData as Vault);
      }

      // Handle social links only if provided
      if (data.socialLinks !&#x3D;&#x3D; undefined) {
        if (data.socialLinks.length &gt; 0) {
          const links &#x3D; data.socialLinks.map(linkItem &#x3D;&gt; {
            return this.linksRepository.create({
              vault: vault,
              name: linkItem.name,
              url: linkItem.url,
            });
          });
          await this.linksRepository.save(links);
        }
      }

      if (data.tags?.length &gt; 0) {
        const tags &#x3D; await Promise.all(
          data.tags.map(async tagData &#x3D;&gt; {
            let tag &#x3D; await this.tagsRepository.findOne({
              where: { name: tagData.name },
            });
            if (!tag) {
              tag &#x3D; await this.tagsRepository.save({
                name: tagData.name,
              });
            }
            return tag;
          })
        );
        vault.tags &#x3D; tags;
        await this.vaultsRepository.save(vault);
      }

      // Handle assets whitelist only if provided
      if (data.assetsWhitelist !&#x3D;&#x3D; undefined &amp;&amp; data.assetsWhitelist.length &gt; 0) {
        await Promise.all(
          data.assetsWhitelist.map(whitelistItem &#x3D;&gt; {
            return this.assetsWhitelistRepository.save({
              vault: vault,
              policy_id: whitelistItem.policyId,
              asset_count_cap_min: whitelistItem?.countCapMin,
              asset_count_cap_max: whitelistItem?.countCapMax,
            });
          })
        );
      }

      // Handle acquirer whitelist only if provided
      if (data.acquirerWhitelist !&#x3D;&#x3D; undefined || acquirerWhitelistFile) {
        const acquirerFromCsv &#x3D; acquirerWhitelistFile ? await this.parseCSVFromS3(acquirerWhitelistFile.file_key) : [];

        const manualAcquirer &#x3D; data.acquirerWhitelist?.map(item &#x3D;&gt; item.walletAddress) || [];
        const allAcquirer &#x3D; new Set([...manualAcquirer, ...acquirerFromCsv]);

        if (allAcquirer.size &gt; 0) {
          const investorItems &#x3D; Array.from(allAcquirer).map(walletAddress &#x3D;&gt; {
            return this.acquirerWhitelistRepository.create({
              vault: vault,
              wallet_address: walletAddress,
            });
          });
          await this.acquirerWhitelistRepository.save(investorItems);
        }
      }

      return await this.prepareDraftResponse(vault.id);
    } catch (error) {
      console.error(error);
      throw new BadRequestException(&#x27;Failed to create vault&#x27;);
    }
  }

  async getMyVaults(
    userId: string,
    filter?: VaultFilter,
    page: number &#x3D; 1,
    limit: number &#x3D; 10,
    sortBy?: VaultSortField,
    sortOrder: SortOrder &#x3D; SortOrder.DESC
  ): Promise&lt;PaginatedResponseDto&lt;VaultShortResponse&gt;&gt; {
    const query &#x3D; {
      where: {
        owner: { id: userId },
        deleted: false,
      },
      relations: [&#x27;social_links&#x27;, &#x27;vault_image&#x27;, &#x27;banner_image&#x27;],
      skip: (page - 1) * limit,
      take: limit,
      order: {},
    };

    if (filter) {
      switch (filter) {
        case VaultFilter.open:
          query.where[&#x27;vault_status&#x27;] &#x3D; In([VaultStatus.published, VaultStatus.contribution, VaultStatus.acquire]);
          break;
        case VaultFilter.locked:
          query.where[&#x27;vault_status&#x27;] &#x3D; VaultStatus.locked;
          break;
        case VaultFilter.contribution:
          query.where[&#x27;vault_status&#x27;] &#x3D; VaultStatus.contribution;
          break;
        case VaultFilter.acquire:
          query.where[&#x27;vault_status&#x27;] &#x3D; VaultStatus.acquire;
          break;
        case VaultFilter.governance:
          query.where[&#x27;vault_status&#x27;] &#x3D; VaultStatus.governance;
          break;
      }
    }

    // Add sorting if specified
    if (sortBy) {
      query.order[sortBy] &#x3D; sortOrder;
    } else {
      // Default sort by created_at DESC if no sort specified
      query.order[&#x27;created_at&#x27;] &#x3D; SortOrder.DESC;
    }

    const [listOfVaults, total] &#x3D; await this.vaultsRepository.findAndCount(query);

    // Transform vault images to URLs and convert to VaultShortResponse
    const transformedItems &#x3D; listOfVaults.map(vault &#x3D;&gt; {
      return plainToInstance(VaultShortResponse, classToPlain(vault), { excludeExtraneousValues: true });
    });

    return {
      items: transformedItems,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  async prepareDraftResponse(id: string) {
    const vault &#x3D; await this.vaultsRepository.findOne({
      where: { id },
      relations: [&#x27;owner&#x27;, &#x27;social_links&#x27;, &#x27;acquirer_whitelist&#x27;, &#x27;tags&#x27;, &#x27;vault_image&#x27;, &#x27;banner_image&#x27;, &#x27;ft_token_img&#x27;],
    });

    if (!vault) {
      throw new BadRequestException(&#x27;Vault not found&#x27;);
    }
    return plainToInstance(VaultFullResponse, vault, { excludeExtraneousValues: true });
  }

  /**
   * Retrieves a vault by ID for a user, including asset and price calculations.
   * @param id - Vault ID
   * @param _userId - User ID (for access control)
   * @returns Full vault response
   */
  async getVaultById(id: string, _userId: string): Promise&lt;VaultFullResponse&gt; {
    const vault &#x3D; await this.vaultsRepository.findOne({
      where: { id, deleted: false },
      relations: [
        &#x27;owner&#x27;,
        &#x27;social_links&#x27;,
        &#x27;assets_whitelist&#x27;,
        &#x27;acquirer_whitelist&#x27;,
        &#x27;vault_image&#x27;,
        &#x27;banner_image&#x27;,
        &#x27;ft_token_img&#x27;,
      ],
    });

    if (!vault) {
      throw new BadRequestException(&#x27;Vault not found&#x27;);
    }

    if (vault.privacy !&#x3D;&#x3D; VaultPrivacy.public) {
      throw new BadRequestException(&#x27;Access denied: You are not the owner of this vault&#x27;);
    }

    // Get count of locked assets for this vault
    const lockedAssetsCount &#x3D; await this.assetsRepository.count({
      where: {
        vault: { id },
        status: AssetStatus.LOCKED,
        type: AssetType.NFT,
        origin_type: AssetOriginType.CONTRIBUTED,
      },
    });

    // todo this is ok for contribution phase, but we need to calculate only assets with origin type CONTRIBUTED
    const assetsPrices &#x3D; await this.taptoolsService.calculateVaultAssetsValue(id);

    // todo for calculate how much ada already invested we need to select assets with INVESTED origin type.
    // todo and here we got how much invested now
    // const investedAssetsPrice &#x3D; await this.taptoolsService.calculateVaultAssetsValue(id, &#x27;acquire&#x27;);

    // Create a new plain object with the additional properties
    const additionalData &#x3D; {
      maxContributeAssets: Number(vault.max_contribute_assets),
      assetsCount: lockedAssetsCount,
      assetsPrices: assetsPrices,
      requireReservedCostAda: assetsPrices.totalValueAda * (vault.acquire_reserve * 0.01),
      requireReservedCostUsd: assetsPrices.totalValueUsd * (vault.acquire_reserve * 0.01),
    };

    // First transform the vault to plain object with class-transformer
    const plainVault &#x3D; classToPlain(vault);

    // Then merge with additional data
    const result &#x3D; {
      ...plainVault,
      ...additionalData,
    };

    return plainToInstance(VaultFullResponse, result, { excludeExtraneousValues: true });
  }

  /**
   * Retrieves paginated and filtered list of vaults accessible to the user, with access control and sorting.
   * @param userId - ID of the user
   * @param filter - Optional vault filter
   * @param page - Page number
   * @param limit - Items per page
   * @param sortBy - Field to sort by
   * @param sortOrder - Sort order
   * @returns Paginated response of vaults
   */
  async getVaults(
    userId: string,
    filter?: VaultFilter,
    page: number &#x3D; 1,
    limit: number &#x3D; 10,
    sortBy?: VaultSortField,
    sortOrder: SortOrder &#x3D; SortOrder.DESC
  ): Promise&lt;PaginatedResponseDto&lt;VaultShortResponse&gt;&gt; {
    // Get user&#x27;s wallet address
    const user &#x3D; await this.usersRepository.findOne({
      where: { id: userId },
    });

    if (!user) {
      throw new BadRequestException(&#x27;User not found&#x27;);
    }

    const userWalletAddress &#x3D; user.address;

    // Create base query for all vaults
    const queryBuilder &#x3D; this.vaultsRepository
      .createQueryBuilder(&#x27;vault&#x27;)
      .leftJoinAndSelect(&#x27;vault.social_links&#x27;, &#x27;social_links&#x27;)
      .leftJoinAndSelect(&#x27;vault.assets_whitelist&#x27;, &#x27;assets_whitelist&#x27;)
      .leftJoinAndSelect(&#x27;vault.vault_image&#x27;, &#x27;vault_image&#x27;)
      .leftJoinAndSelect(&#x27;vault.banner_image&#x27;, &#x27;banner_image&#x27;)
      .leftJoinAndSelect(&#x27;vault.ft_token_img&#x27;, &#x27;ft_token_img&#x27;)
      .leftJoinAndSelect(&#x27;vault.tags&#x27;, &#x27;tags&#x27;)
      .leftJoinAndSelect(&#x27;vault.contributor_whitelist&#x27;, &#x27;contributor_whitelist&#x27;)
      .leftJoinAndSelect(&#x27;vault.acquirer_whitelist&#x27;, &#x27;acquirer_whitelist&#x27;)
      .where(&#x27;vault.vault_status !&#x3D; :draftStatus&#x27;, { draftStatus: VaultStatus.draft })
      .andWhere(&#x27;vault.deleted !&#x3D; :deleted&#x27;, { deleted: true })
      .andWhere(&#x27;vault.vault_status !&#x3D; :createdStatus&#x27;, { createdStatus: VaultStatus.created })
      // Get public vaults OR private vaults where user is whitelisted based on filter
      .andWhere(
        new Brackets(qb &#x3D;&gt; {
          qb.where(&#x27;vault.privacy &#x3D; :publicPrivacy&#x27;, { publicPrivacy: VaultPrivacy.public }).orWhere(
            new Brackets(qb2 &#x3D;&gt; {
              qb2.where(&#x27;vault.privacy &#x3D; :privatePrivacy&#x27;, { privatePrivacy: VaultPrivacy.private }).andWhere(
                new Brackets(qb3 &#x3D;&gt; {
                  // Default case - check both whitelists if no filter
                  qb3.where(
                    &#x27;(EXISTS (SELECT 1 FROM contributor_whitelist cw WHERE cw.vault_id &#x3D; vault.id AND cw.wallet_address &#x3D; :userWalletAddress) OR EXISTS (SELECT 1 FROM acquirer_whitelist iw WHERE iw.vault_id &#x3D; vault.id AND iw.wallet_address &#x3D; :userWalletAddress))&#x27;,
                    { userWalletAddress }
                  );
                })
              );
            })
          );
        })
      );

    // Apply status filter and corresponding whitelist check
    if (filter) {
      switch (filter) {
        case VaultFilter.open:
          queryBuilder
            .andWhere(&#x27;vault.vault_status IN (:...statuses)&#x27;, {
              statuses: [VaultStatus.published, VaultStatus.contribution, VaultStatus.acquire],
            })
            .andWhere(
              new Brackets(qb &#x3D;&gt; {
                qb.where(&#x27;vault.privacy &#x3D; :publicPrivacy&#x27;, { publicPrivacy: VaultPrivacy.public }).orWhere(
                  &#x27;EXISTS (SELECT 1 FROM contributor_whitelist cw WHERE cw.vault_id &#x3D; vault.id AND cw.wallet_address &#x3D; :userWalletAddress)&#x27;,
                  { userWalletAddress }
                );
              })
            );
          break;
        case VaultFilter.contribution:
          queryBuilder.andWhere(&#x27;vault.vault_status &#x3D; :status&#x27;, { status: VaultStatus.contribution }).andWhere(
            new Brackets(qb &#x3D;&gt; {
              qb.where(&#x27;vault.privacy &#x3D; :publicPrivacy&#x27;, { publicPrivacy: VaultPrivacy.public }).orWhere(
                &#x27;EXISTS (SELECT 1 FROM contributor_whitelist cw WHERE cw.vault_id &#x3D; vault.id AND cw.wallet_address &#x3D; :userWalletAddress)&#x27;,
                { userWalletAddress }
              );
            })
          );
          break;
        case VaultFilter.acquire:
          queryBuilder.andWhere(&#x27;vault.vault_status &#x3D; :status&#x27;, { status: VaultStatus.acquire }).andWhere(
            new Brackets(qb &#x3D;&gt; {
              qb.where(&#x27;vault.privacy &#x3D; :publicPrivacy&#x27;, { publicPrivacy: VaultPrivacy.public }).orWhere(
                &#x27;EXISTS (SELECT 1 FROM acquirer_whitelist iw WHERE iw.vault_id &#x3D; vault.id AND iw.wallet_address &#x3D; :userWalletAddress)&#x27;,
                { userWalletAddress }
              );
            })
          );
          break;
        case VaultFilter.governance:
          queryBuilder.andWhere(&#x27;vault.vault_status &#x3D; :status&#x27;, { status: VaultStatus.governance }).andWhere(
            new Brackets(qb &#x3D;&gt; {
              qb.where(&#x27;vault.privacy &#x3D; :publicPrivacy&#x27;, { publicPrivacy: VaultPrivacy.public }).orWhere(
                &#x27;(EXISTS (SELECT 1 FROM contributor_whitelist cw WHERE cw.vault_id &#x3D; vault.id AND cw.wallet_address &#x3D; :userWalletAddress) OR EXISTS (SELECT 1 FROM acquirer_whitelist iw WHERE iw.vault_id &#x3D; vault.id AND iw.wallet_address &#x3D; :userWalletAddress))&#x27;,
                { userWalletAddress }
              );
            })
          );
          break;
        case VaultFilter.locked:
          queryBuilder.andWhere(&#x27;vault.vault_status &#x3D; :status&#x27;, { status: VaultStatus.locked });
          break;
      }
    }

    // Apply sorting
    if (sortBy) {
      queryBuilder.orderBy(&#x60;vault.${sortBy}&#x60;, sortOrder);
    } else {
      // Default sort by created_at DESC
      queryBuilder.orderBy(&#x27;vault.created_at&#x27;, SortOrder.DESC);
    }

    // Get paginated results
    const [items, total] &#x3D; await queryBuilder
      .skip((page - 1) * limit)
      .take(limit)
      .getManyAndCount();

    // Transform vault images to URLs and convert to VaultShortResponse
    const transformedItems &#x3D; items.map(vault &#x3D;&gt; {
      return plainToInstance(VaultShortResponse, classToPlain(vault), { excludeExtraneousValues: true });
    });

    return {
      items: transformedItems,
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    };
  }

  /**
   * Attempts to burn (liquidate) a vault, creating a burn transaction if the vault is empty and owned by the user.
   * @param vaultId - Vault ID
   * @param userId - User ID
   * @returns Burn transaction result
   */
  async burnVaultAttempt(vaultId: string, userId: string) {
    const vault &#x3D; await this.vaultsRepository.findOne({
      where: {
        id: vaultId,
        owner: {
          id: userId,
        },
      },
      relations: [&#x27;assets&#x27;, &#x27;owner&#x27;],
    });
    if (!vault) {
      throw new Error(&#x27;Vault is not found or you are not owner of this vault!&#x27;);
    }
    if (vault.assets.length !&#x3D;&#x3D; 0) {
      throw new Error(&#x27;The vault cant be burned it need to extract and refound assets &#x27;);
    }
    const transaction &#x3D; await this.transactionsService.createTransaction({
      vault_id: vaultId,
      type: TransactionType.burn,
      assets: [],
    });
    const result &#x3D; await this.vaultContractService.createBurnTx({
      assetVaultName: vault.asset_vault_name,
      customerAddress: vault.owner.address,
    });

    return {
      ...result,
      txId: transaction.id,
    };
  }

  /**
   * Publishes a burn transaction for a vault, marking it as deleted and saving the liquidation hash.
   * @param vaultId - Vault ID
   * @param userId - User ID
   * @param publishDto - PublishVaultDto containing transaction data
   */
  async burnVaultPublishTx(vaultId, userId, publishDto: PublishVaultDto) {
    const { txHash } &#x3D; await this.vaultContractService.submitOnChainVaultTx({
      transaction: publishDto.transaction,
      signatures: publishDto.signatures,
    });

    const vault &#x3D; await this.vaultsRepository.findOne({
      where: {
        id: vaultId,
        owner: {
          id: userId,
        },
      },
      relations: [&#x27;assets&#x27;, &#x27;owner&#x27;],
    });
    if (!vault) {
      throw new Error(&#x27;Vault is not found or you are not owner of this vault!&#x27;);
    }
    if (vault.assets.length !&#x3D;&#x3D; 0) {
      throw new Error(&#x27;The vault cant be burned it need to extract and refound assets &#x27;);
    }
    vault.deleted &#x3D; true;
    vault.liquidation_hash &#x3D; txHash;
    // todo need to wait tx approvement from scanner ?
    await this.transactionsService.updateTransactionHash(publishDto.txId, txHash);
    await this.vaultsRepository.save(vault);
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'VaultsService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
