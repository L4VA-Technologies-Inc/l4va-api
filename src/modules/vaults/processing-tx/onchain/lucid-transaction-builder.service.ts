// lucid-transaction-builder.service.ts
import { Address } from '@emurgo/cardano-serialization-lib-nodejs';
import {
  applyParamsToScript,
  Blockfrost,
  Constr,
  Data,
  fromHex,
  fromText,
  Lucid,
  LucidEvolution,
  MintingPolicy,
} from '@lucid-evolution/lucid';
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';

import { TransactionsService } from '../offchain-tx/transactions.service';

import { BuildTransactionParams } from './vault-inserting.service';

import { Vault } from '@/database/vault.entity';
import blueprint from '@/modules/vaults/processing-tx/onchain/utils/blueprint.json';

const yourCompiledScript =
  '592202010100332229800aba4aba2aba1aba0aab9faab9eaab9dab9a9bae0039bae0024888888888966003300130053754017370e90004dc3a400523009300a300a300a300a300a001918049805180518051805180518051805000c8c024c0280066e95200091919800800801112cc004006297ae08991991199119801001000912cc004006200713233010374e660206ea4014cc040c034004cc040c0380052f5c066006006602400460200028070dd598058019bae300800133003003300d002300b00140252259800800c52f5c11330093006300a00133002002300b00140212259800800c5268992cc00400629344c96600266e40dd7180418060019bae30080018998020021980580098068014590071805800a012300b0014021259800800c528c528200e911919800800801912cc00400629422b30013371e6eb8c03000400e2946266004004601a002803900a48c024c028c028c028c028006460126014601460146014601460146014601460146014601460146014601400323009300a300a300a300a300a300a300a300a0019b87480124464660020020064466006002600400523009300a300a001912cc0040062900044cdc02400466004004601600280424646600200200444b30010018a5eb7bdb1822653001375c601000337566012003300d00248896600266e45221000038acc004cdc7a441000038800c401500a44cc038cdd81ba9003374c0046600c00c00280506016002804a6e1d20069b87480224601260146014601460146014601460146014601460146014002911111111111111111111114c004c08005e603e02f223259800980c800c4c8c966002604a0050048b2044375c6046002603e6ea800e2b30013018001899192cc004c09400a0091640886eb8c08c004c07cdd5001c5901d203a301d3754005223259800980c800c4c8c966002604a0050048b2044375c6046002603e6ea800e2b300130180018acc004c07cdd5001c00a2c81022c80e901d180e9baa002912cc004c8c966002603400314a3159800980c800c4c966002603460406ea8c05cc084dd5181218109baa005899b89001004899b88001004407c6eb4c08cc080dd50014528203c4078603c6ea8004c084c078dd51810980f1baa002899192cc004c06800629422b300130190018992cc004c068c080dd5180b98109baa30173021375400b13371200800313371000800280f8dd6981198101baa0028a51407880f0c078dd50009810980f1baa3014301e375400514a080e2444b30010028a6103d87a80008acc004c0640062602866042604400497ae08cc00400e6046005337000029000a00640748102601e01f300e00e91111919800800802912cc00400626604866ec0dd48029ba60044bd6f7b63044ca60026eb8c0880066eacc08c006604e0049112cc004cdc8004801c4cc0a0cdd81ba9009374c01000b15980099b8f0090038992cc004c084c098dd5000c4cc0a4cdd81ba900a302a30273754002005100240953001009804400900744cc0a0cdd81ba9003374c0046600c00c00281210240c09400502348888c8cc0040040148966002003133024337606ea4014dd400225eb7bdb1822653001375c6044003375a6046003302700248896600266e4002400e26605066ec0dd48049ba80080058acc004cdc7804801c4c9660026042604c6ea800626605266ec0dd4805181518139baa0010028801204a9800804c022004803a26605066ec0dd48019ba80023300600600140908120604a002811a44646600200200644b30010018a6103d87a8000899192cc004cdc8802800c56600266e3c0140062602e66048604400497ae08a60103d87a80004081133004004302600340806eb8c080004c08c005021488cc038dd61805980f1baa002001912cc004c060c074dd500144c8c8c966002604a0051323259800980e800c56600260466ea800a00d164091159800980e000c4c8c96600260520050088b204c375a604e00260466ea800a2b3001300f0018acc004c08cdd5001401a2c81222c8109021204230213754002604800716408864b300130210018acc004cdc4a40086040003168980d1810000a03e8b2044375460460026046002603c6ea800a2c80e24464b30013019001899192cc004c09400a0091640886eb4c08c004c07cdd5001c5660026030003159800980f9baa00380145902045901d203a301d3754005223232598009806000c4c054cc088c08cc080dd500125eb822b3001301900189919198008009bab302530263026302630263026302630263026302630263022375400a44b30010018a6103d87a8000899192cc004cdc8802800c56600266e3c014006260346604e604a00497ae08a60103d87a8000408d1330040043029003408c6eb8c08c004c0980050241bae30233020375400514c103d87a8000407880f0c078dd50009804180f1baa0029802802c888ca6002003003801200222259800980d98109baa0068800c56600200510018991919914c00401e605400d3370000a66e08c8cc004004dd6181518139baa00b2259800800c52000899194c004c0b40066eb4c0b4c0b8006605c007375c605a00491112cc004cdc7800804c566002604e605a6ea8012200715980099b8f375c6062605c6ea801002a200713300800800240b081622660100100048160605a0026eb0c0ac0050291bad3029302a003401c6eb8c09c004dd7181380118138009bac3025002408c81012222222222222222298009818008cc0c0c0c404644b30013029302e3754005132323259800981b00144cc050c0d400c4c966002605a00313259800981c000c4c8c966002606000313259800981d800c4cc064c0e80040262c81c0c0d8dd50014566002605e003132323298009bad303c0019bad303c0039bad303c002488966002608000900e8b207a181e000981d800981b1baa0028b206840d060686ea8004c0dc0062c81a8c0ccdd50014566002605800315980098199baa002802c590344590312062303137540031640cc60680026068002605e6ea800a2c816a44b30013259800981498179baa0018998080019bad30333030375400314a08170c0c8c0bcdd5181298179baa0018992cc004c0a4c0bcdd5000c4cc04000cdd6981998181baa0018a5040b86064605e6ea8c0c8c0bcdd5000c528205a98060064888a6002009003801488a6002007001801200840352259800981498171baa00289919192cc004c0d800a266014606a0062660140020091640cc60680026068002605e6ea800a2c816a44464b3001302a3030375400314800226eb4c0d0c0c4dd5000a05e3259800981518181baa0018a6103d87a8000899198008009bab30353032375400444b30010018a6103d87a8000899192cc004cdc8803000c56600266e3c018006260546606e606a00497ae08a60103d87a800040cd133004004303900340cc6eb8c0cc004c0d8005034205e3300a00300291194c0040060070024004444b30010028800c4ca60020093037003cc00400a6eb8c0c80066eacc0cc00644464b300130280018a6103d87a8000898161981c9ba60014bd70206a329800800c00e00480088896600200510018994c004012607c00798008014dd7181c800cdd6981d000c888c966002607000314c103d87a800089819998201ba80014bd7020783370000400280a9004181e0012074403c8020c0d400903348c00c0064464b3001302a0018992cc004c0d400626601060680020071640c860606ea800e2b300130290018992cc004c0d400626601060680020071640c860606ea800e2b3001301c0018991919912cc004c0e000e00d1640d46eb4c0d4004dd6981a801181a80098181baa0038acc004c05c006264b30013035001899804181a000801c5903218181baa0038acc004c058006264b30013035001899804181a000801c5903218181baa0038b205c40b8817102e205c302e3754004911111111114c004c0dcdd500548966002606860726ea800a264646465300130410019bae30410049bae3041003488966002608a00913301230440051330220030088b208418208009820000981f800981d1baa0028b207091112cc004c0d8006200919800802400e646400460340026607c66ec0dd48011ba80014bd6f7b6304888c966002606200314c103d87a80008981a998211ba60014bd70207c980080140160092223259800981e800c530103d87a80008981c198229ba80014bd7020823370000200480d100a207491111919800800801912cc004006298103d87a80008992cc004c0e660026eacc0d4c0fcdd5181a981f9baa001803c01900b44cc00c00cc10c00a264b3001303a303f375400313259800981d98201baa00189919191919191919191919191919194c004dd71829800cdd69829807cdd698298074c14c03260a6017305300a9bad305300998298044dd59829803cc14c01a60a600b30530049829801cdd71829801244444444444444b3001306200f8998249bac306101b225980080144cc896600260b8003132598009833800c4cc138dd61833000912cc00400a00b1323002306a003375c60d000483322c8320c188dd5007c56600260b600315980098311baa00f80145906345906020c013302d00c13302d00b1332259800982e000c4c96600260ce00313259800982f18319baa0018991919194c004dd71835800cdd698358024dd69835801cdd6983580124444b3001307000580645906d0c1ac004c1a8004c1a4004c190dd5000c590621833000c5906418311baa00b8acc004c16c0062b3001306237540170028b20c68b20c0418026609601044b3001002899912cc004c178006264b300130690018992cc004c180c194dd5000c4c8c8cc896600260dc0070088b20d6375a60d60026eb4c1ac008c1ac004c198dd5000c590641834000c5906618321baa00b8acc004c1740062b3001306437540170028b20ca8b20c4418826644b3001305e0018992cc004c1a4006264b3001306030653754003132323322598009837001c0222c8358dd698358009bad306b002306b0013066375400316419060d000316419860c86ea802a2b3001305d0018acc004c190dd5005400a2c832a2c8311062099912cc004c178006264b300130690018998281bac30680012259800801401626464646644b300130700038998269837802098031838003c5906d1bad306d001375c60da00660da00260d80026eb0c1a800906845906618321baa0098acc004c1740062b3001306437540130028b20ca8b20c4418826607200c260ae660c804497ae03061375400e60c26ea8020c184dd5004c4c8cc88c010c1a4014dd718310009bae30630013065002418c60be6ea8024c17cdd5006c4c8c008c19400cdd7183180120c28b20be1829800982900098288009828000982780098270009826800982600098258009825000982480098240009823800982300098209baa0018b207e3043304037540031640f86602a606a607e6ea800401103d1820800a07e48888c966002606e00b132332259800981d000c4c8cc8966002608e0031323259800981f800c566002608a6ea800a00f164119159800981f000c566002608a6ea800a00f16411916410c8218c10cdd50009823000c590441bad3044001304500130403754027159800981c800c56600260806ea804e0051641051598009816000c56600260806ea804e0051641051598009813800c56600260806ea804e0051641051640f881f103e207c13259800981c981f1baa0018994c004cc06408cdd7181718201baa00198161bad304330403754003303f37540269112cc004c0f400626464b3001303f304437540031323259800982018231baa0018cc004cdc79bae304a3047375400201559800982098231baa304a304b0048acc004cc05cc0fcc11cdd5004181f18239baa02a899baf374c605e6eacc0f4c11cdd50011ba69800a5eb7bdb1820154881077265636569707400a4004806a2941045456600264664466004004607c606400244b30010018a518acc004cc0e800cdd718269bac304d0018998010011827000c5282090412c6eacc0f8c120dd500199199119801001000912cc004006200713304c304d00133002002304e001412c6eb0c0c8c120dd5004998249ba900a4bd7044cc05cc0d8c11cdd5004181f18239baa02a8a504114822a64b300130423047375400313232330010013758606e60946ea80b4896600200314a11598009981d8019bae304e0018a518998010011827800a09241306eb0c12cc120dd5000c528a08c304a304b304b304b304737540113300b302f3756606c608e6ea80a8cc124dd480525eb826603a0040549111119912cc004c120c134dd5001c4c8cc05800456600201f159800804456600200f1598008034566002007159800acc004cdc79bae3052304f375400202513371e6eb8c114c13cdd5000825c528209a8acc00400a3300100ea50a51413514a0826a294104d4528209a8a50413514a0826a294104d4528209a3051304e375400716413066ebcdd30011ba632330010013304f337606ea404130010aa1477265636569707401004bd6f7b630112cc004006297adef6c608994c004dd71827000cdd59827800ccc00c00cc14c0092229800800c00e6464008646600200200844b30010018a4d13259800800c56600260086eb4c158c16400a29345905444cc896600266e40dd7182b8011bae30570018acc004c018dd6982c00144cc014014cc168004c17000e2c82b22c82b0c164008c164005057182c800a0ac298009826800d28528a0a2911320401828800a09e3375e6e98cc040c0d0dd5982118261baa0073304e375201e97ae0374c0048b208a3049304637546092608c6ea8004c120c114dd5000c59043198099bac302e3044375404e6eb4c11c004c10cdd500b44c966002607a00513375e606660886ea809cdd34c004dd6182398221baa027803c01604f4bd6f7b63020028acc004c0c000a266ebcc0ccc110dd50139ba698009bac30473044375404f007802c09e97adef6c604005159800acc004c8cc004004c0e4cc024dd5981a18229baa02833047375201097ae02259800800c52f5c1133225980099b8848000dd698259826182600144cc128dd380119802002000c4cc0100100050461bac3049001304a001411d14a314a0822a200914a08211042208422222329800800c01a00480088896600200510018994c00401260a00073301700259800992cc004c118c130dd5000c4cdc79bae3050304d375400201314a08258c13cc130dd5182798261baa3042304c375400313259800982398261baa0018991980b8008992cc004c124c138dd5000c4c9660026094609e6ea800626464646464b300130590028999119814182d00289981c0018994c006600297adef6c60801c00a66e00c96600260a600315980098290014566002608a60466eacc13cc164dd51827982c9baa00e8cc004c0f8c164dd500a4c134dd59827982c9baa304f3059375401d4800102d466002607c60b26ea8052609a60826eacc13cc164dd51827982c9baa00ea40008169057452000415d1598009829000c56600260a4005159800982298119bab304f30593754609e60b26ea803a33001303e30593754029304d3756609e60b26ea8c13cc164dd50075200040b519800981f182c9baa014982698209bab304f30593754609e60b26ea803a9000205a415d1480010574566002608a00315980098290014566002608a60466eacc13cc164dd51827982c9baa00e8cc004c0f8c164dd500a4c134dd59827982c9baa304f3059375401d4800102d466002607c60b26ea8052609a60826eacc13cc164dd51827982c9baa00ea40008169057452000415d14800105720ae415c60ae6ea802d6600260a460ae6ea802e264b30013053305837540031337046eb4c170c164dd5000cc004dd59827982c9baa304f3059375401d48900a441004095148001057182d982e182e182e182e182e182e182e182e182e182e182e182e182c1baa0138a400082b101e400e91107726563656970740099b814800000501e4c004dd59826982b9baa304d30573754019002a441077265636569707400408c6eb8c160014dd7182c002459056182b800982b800982b000982a80098281baa0018b209c3052304f3754003164134660486088609c6ea800c020c140c134dd5000c5904b19199119801001000912cc004006298103d87a80008992cc004cdd78021827800c4c114cc148c1400052f5c11330030033054002413860a40028280dd5982818289828982898289828982898289828982898269baa0073374a900119827182798261baa0014bd70452f5bded8c082510041827001209841043042303f37540031640f5300103b81d4dd6181a181f1baa021810a006303d37540226eb8c100c0f4dd5007c566002606c00b132332233009013159800981d181f9baa001899912cc004c0f0c104dd5000c4c8cc8966002607e60886ea800633001304830453754003237286ecc006444b30010028a508994c004c966002608860926ea800626eb4c128c134dd5982698251baa0018a40008240c1300066ebcc130c1340066eac00d22259800800c566002600400d13300500348002294104a44c96600266ebcc13000530010140008acc004cc018010dd6982698281bab304d001898019ba630510028a50412d1598009980300224001130030078a50412c8258c13c00504d0ca60020030049119826801198269ba60014bd7020022225980080144cc005300103d87a80004bd6f7b63044ca60026eb8c12c0066eacc13000660a00069112cc004cdc8a441000038acc004cdc7a441000038998029822198289ba60024bd70000c4cc015300103d87a8000006413519800803c006446600e004660a666ec0dd48029ba6004001401c8268609c004826229422942294104d489660026644b300130433048375400513259800982218249baa0018992cc004c114c128dd5000c4cc0ecdd6181c18259baa006375c609c60966ea80060068248c134c128dd5000c009048182618249baa002800a08e303d3047375400229422946264b30013042304737540031330383758606a60906ea800cdd7182598241baa0018a5041186094608e6ea800504548c0b4dd6982498231baa00198221baa01891192cc004c104c11cdd5000c4cc8966002608660926ea8006264b30013044304a3754608260966ea8c104c12cdd500344cdc4000801c4cdc4800801a092375a609a60946ea800629410481bad304b30483754002609660906ea8c0f8c120dd5001c528208c304a30473754607a608e6ea80066ebd30101a000488888888c8cc8966002609400d133225980098031ba6303a3756609060a46ea8c120c148dd5006c56600201f10018a504141159800982618289baa0028992cc004c134c148dd5000c566002021159800cc0040da60ac60a66ea80066eacc124c14cdd5182498299baa00e809c056607060a66ea80450044400a2941051452820a28b20a2330213758607860a46ea80d4dd6982a98291baa0028b20a0414060a660a06ea808ccc014c120c140dd5007182398281baa0338acc004c12401a26644b30019800cc004c018dd31980b1bab304830523754609060a46ea8034cc150c154c148dd500925eb82942945050528528a0a08acc00403e200314a082822b3001304c3051375400513259800982698291baa0018acc0040422b3001980081b4c158c14cdd5000cdd5982498299baa30493053375401d01380acc0e0c14cdd5008a0088801452820a28a504145164144660426eb0c0f0c148dd501a9bad3055305237540051641408280c14cc140dd501199802981f98281baa00e304730503754067159800981e00344c8c966002609860a26ea8006264b3001304d30523754003159800cc0040da60ac60a66ea800a6eacc124c14cdd5182498299baa00e809c056607060a66ea804500444cc896600330013009374c0034a14a2829a3300198009bab304b30553754005374c660406eacc12cc154dd51825982a9baa01032330010010022259800800c52f5bded8c11323305a3376060ae0026e98c8cc004004dd5982c801112cc004006297adef6c608991982e99bb0305a001375066e052000375a60b60026600600660be00460ba00282d8cc00c00cc170008c168005058488cdc4800801201c99baf30583055375400460b060aa6ea8c12cc154dd50084cc0acc12cc154dd500801c2444b3001305230573754003132330200011332259800982a982d1baa001899198118008acc00401e2b3001006899baf0030018a50416914a082d0c178c16cdd5000c59059191918281982e982f0011982e982f0009982e982f182f8009982e98281982e9ba9301501d4bd7025eb80c178004c164dd50009981780301e182d982c1baa0018b20ac459053182b18299baa001330173756609260a66ea8c124c14cdd50071982a982b18299baa0134bd70452820a28b20a2330213758607860a46ea80d4dd6982a982b001459050198101bac303b305137540686eb4c150004c140dd5011c566002606e00d1332259800cc004c024042942945050456600264b30013039001899811982598299baa011304a3053375406d159800981d000c4cc08cc108c14cdd5008982518299baa0368a5041448288c144dd5012c5660026601406a607860a46ea804a200314a0828229410504566002609860a26ea800a264b3001304d30523754003159800cc0040da60ac60a66ea800601d01380aa00a8801452820a28b20a2330213758607860a46ea80d4dd6982a98291baa0028b20a0414060a660a06ea808ccdc44c004dd5981f98281baa0339bae3053305037540214890772656365697074004070900044cc896600330013009010a50a514141159800992cc004c0e4006266046609660a66ea8044c128c14cdd501b45660026074003133023304230533754022609460a66ea80da294105120a23051375404b1598009980501a981e18291baa0128800c52820a08a504141159800982618289baa0028992cc004c134c148dd5000c5660033001036982b18299baa001807404e02a802a200514a0828a2c8288cc084dd6181e18291baa035375a60aa60a46ea800a2c8281050182998281baa0233371130013756607e60a06ea80ce6eb8c14cc140dd5008522107726563656970740040709000209c4138827104e11111192cc004c138c14cdd5000c56600330013756609460a86ea80166e9a60026eacc128c150dd51825182a1baa0049bae305730543754007489077265636569707400a400280d24466e2400400900d456600266ebcc15cc150dd5002981f182a1baa003899803982b982a1baa0010028a50414914a082922c8290cc0a4010014888888c966002609e60a86ea80062b30013370f30013756609660aa6ea801a6eb8c160c154dd50024dd71825982a9baa0044084b3001304e33702603e00b30010059bae3058305537540094890772656365697074004085198008014c124016900020528cc00400a6092607a00b4800102920a68acc004cdd7982c182a9baa006303f3055375400913300830583055375400200714a0829a2941053459053198150028031119b8f37666ea4c024004dd980122c8218cc070098dd7181898219baa00132330010013758608e60886ea809c896600200314c0103d87a80008992cc004cdd7982498231baa0010088981d99824000a5eb8226600600660940048220c120005046182298211baa0018b2080304330403754003300103d81e4dd6181b18201baa023811a00a8b207c304100130413042001303d375401f1640ec81d888c8cc004004c07400c896600200314bd6f7b63044cc89660026606400a005132330010013259800981e98219baa0018a5eb7bdb18226eacc11cc110dd5000a0843301d0070032259800800c400e2653001330030033049002802cdd71822000cdd69822800a01630470014115100141006eb8c10c004cc008008c1100050410452689b2b200626011e581c2de3551bbd703dd03d57bb4d16027a73b0501977dc830885523bb1e6004c01225820aa263dacdd37d849f75869ebf513b97939f0cbed69efe9cf03bd1a05bbfbfb740001';

@Injectable()
export class LucidTransactionBuilderService {
  private readonly logger = new Logger(LucidTransactionBuilderService.name);
  private readonly adminSKey: string;
  private readonly adminAddress: string;
  private lucid: LucidEvolution;

  constructor(
    @InjectRepository(Vault)
    private readonly vaultsRepository: Repository<Vault>,
    private readonly configService: ConfigService,
    private readonly transactionsService: TransactionsService
  ) {
    this.adminSKey = this.configService.get<string>('ADMIN_S_KEY');
    this.adminAddress = this.configService.get<string>('ADMIN_ADDRESS');

    this.initializeLucid();
  }

  private async initializeLucid(): Promise<void> {
    this.lucid = await Lucid(
      new Blockfrost(
        'https://cardano-preprod.blockfrost.io/api/v0',
        this.configService.get<string>('BLOCKFROST_TESTNET_API_KEY')
      ),
      'Preprod'
    );
  }

  async buildAdaContribution(params: BuildTransactionParams): Promise<{ presignedTx: string }> {
    const transaction = await this.transactionsService.validateTransactionExists(params.txId);

    const vault = await this.vaultsRepository.findOne({
      where: {
        id: transaction.vault_id,
      },
    });

    if (!vault.publication_hash) {
      throw new Error('Vault publication hash not found - vault may not be properly published');
    }

    if (!vault.script_hash) {
      throw new Error('Vault script hash is missing - vault may not be properly configured');
    }

    const VAULT_ID = vault.asset_vault_name;
    const POLICY_ID = vault.script_hash;
    const quantity = params.outputs[0].assets[0].quantity * 1000000; // Convert to lovelace

    try {
      this.lucid.selectWallet.fromAddress(params.changeAddress, []);

      // Get user's UTXOs
      const userUtxos = await this.lucid.utxosAt(params.changeAddress);
      if (userUtxos.length === 0) {
        throw new Error('No UTXOs found for the user address');
      }

      // Find a UTxO containing a reference script
      const allUTxOs = await this.lucid.utxosByOutRef([{ txHash: vault.publication_hash, outputIndex: 1 }]); // Vault on 0 index
      const refScriptUTxO = allUTxOs.filter(utxo => utxo.scriptRef)[0];

      if (!refScriptUTxO) {
        throw new Error('No reference script UTxO found for the vault');
      }

      const addressHex = Buffer.from(Address.from_bech32(params.changeAddress).to_bytes()).toString('hex');

      // For datum: { policy_id, asset_name, owner }
      const contributionDatum = Data.to(
        new Constr(0, [
          POLICY_ID, // policy_id as hex string
          VAULT_ID, // asset_name as hex string
          addressHex,
        ])
      );

      const contributionScript = blueprint.validators.find(v => v.title === 'contribute.contribute');
      if (!contributionScript) {
        throw new Error('Conribution script not found in blueprint');
      }

      this.logger.debug(contributionScript.compiledCode === yourCompiledScript);

      const scriptWithParams = applyParamsToScript(yourCompiledScript, [
        '2de3551bbd703dd03d57bb4d16027a73b0501977dc830885523bb1e6',
        VAULT_ID,
      ]);

      const mintingPolicy: MintingPolicy = {
        type: 'PlutusV3',
        script: scriptWithParams,
      };

      // For redeemer: { output_index: 0, contribution: "Lovelace" }
      const mintingRedeemer = Data.to(
        new Constr(0, [
          0n, // output_index
          fromText('Lovelace'),
        ])
      );

      const tx = await this.lucid
        .newTx()
        // Mint receipt token
        .mintAssets(
          {
            [POLICY_ID + fromText('receipt')]: 1n,
          },
          mintingRedeemer
        )
        .pay.ToContract(
          vault.contract_address,
          {
            kind: 'inline',
            value: contributionDatum,
          },
          {
            lovelace: BigInt(quantity),
            [POLICY_ID + fromText('receipt')]: 1n,
          }
        )
        .attach.MintingPolicy(mintingPolicy)
        .readFrom([refScriptUTxO])
        .addSigner(params.changeAddress)
        .addSigner(this.adminAddress)
        .validFrom(Date.now() - 60000)
        .validTo(Date.now() + 3600000)
        .complete();

      await tx.sign.withWallet().partialSign.withPrivateKey(this.adminSKey);
      // this.logger.debug(adminSignedTx);

      return {
        presignedTx: tx.toHash(), // Should return hex
      };
    } catch (error) {
      this.logger.error(`Failed to build ADA contribution transaction: ${error.message}`, error);
      throw error;
    }
  }
}
